<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Datos | ONG Colaboraci√≥n</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ========================================================= */
        /* CSS STYLES (PROFESIONAL Y RESPONSIVE)                     */
        /* ========================================================= */

        /* Variables de Color (Incluyendo estados de tutora) */
        :root {
            --color-primario: #0e7490; /* Azul Cian Profundo */
            --color-secundario: #4ade80; /* Verde Lima Brillante */
            --color-fondo: #f8fafc; /* Fondo muy claro */
            --color-card: #ffffff; /* Blanco para tarjetas */
            --color-texto: #1f2937; /* Gris oscuro */
            --color-alerta: #ef4444; /* Rojo para errores */
            --color-exito: #16a34a; /* Verde oscuro para √©xito */
            --color-completo: #dcfce7; /* Verde Claro para Tutora (√âxito) */
            --color-incompleto: #fee2e2; /* Rojo Claro para Tutora (Alerta) */
            --sombra-card: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            line-height: 1.6;
            padding: 20px;
        }

        /* -------------------- LAYOUT Y UI -------------------- */
        .contenedor { max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; gap: 30px; }
        header { text-align: center; padding: 30px 0; }
        .logo-container { font-size: 2.5rem; font-weight: 700; color: var(--color-primario); margin-bottom: 10px; }
        .resaltado { color: var(--color-secundario); }
        h1 { font-weight: 700; color: var(--color-texto); margin-top: 5px; font-size: 2rem; }

        .consentimiento-box {
            background-color: #e0f2f7; color: #0e7490; padding: 20px; border-radius: 8px;
            border-left: 5px solid var(--color-primario); font-size: 0.95rem; font-weight: 500;
        }

        .card {
            background-color: var(--color-card); padding: 30px; border-radius: 12px;
            box-shadow: var(--sombra-card); transition: transform 0.3s ease-out, box-shadow 0.3s ease-out, opacity 0.5s ease;
        }
        
        /* Animaci√≥n de entrada suave */
        .anim-entrada { opacity: 0; transform: translateY(20px); animation: fadeInSlide 0.5s ease-out forwards; }
        @keyframes fadeInSlide { to { opacity: 1; transform: translateY(0); } }
        
        .paso-titulo {
            color: var(--color-primario); font-size: 1.6rem; margin-bottom: 20px; font-weight: 700;
            border-bottom: 3px solid var(--color-secundario); padding-bottom: 5px;
        }

        /* -------------------- NAVEGACI√ìN DE PESTA√ëAS -------------------- */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            padding: 10px 15px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer;
            background-color: #e5e7eb; font-weight: 600; color: #4b5563; transition: background-color 0.3s, color 0.3s;
        }
        .tab-btn.active {
            background-color: var(--color-primario); color: white; border-color: var(--color-primario);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* -------------------- FORMULARIO BASE -------------------- */
        .input-grupo { margin-bottom: 15px; display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 5px; color: var(--color-texto); }
        input:not([type="checkbox"]), select {
            padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .grid-fecha { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* -------------------- SECCI√ìN TUTORA (NUEVA) -------------------- */
        .select-tutora-box { padding: 20px; border: 1px dashed #ccc; border-radius: 8px; margin-bottom: 20px;}
        .tutora-participante-list { display: grid; gap: 15px; }

        .participante-item {
            padding: 15px; border-radius: 8px; font-weight: 600; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s;
        }
        
        .participante-item.completo { background-color: var(--color-completo); color: var(--color-exito); border: 1px solid var(--color-exito); }
        .participante-item.incompleto { background-color: var(--color-incompleto); color: var(--color-alerta); border: 1px solid var(--color-alerta); }
        .participante-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .participante-item.selected { border: 3px solid var(--color-primario); transform: scale(1.02); }

        .tag-estado { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; font-weight: 700; }
        .tag-completo { background-color: var(--color-exito); color: white; }
        .tag-incompleto { background-color: var(--color-alerta); color: white; }
        .tag-bloqueado { background-color: #6b7280; color: white; }
        
        /* Estilo para el formulario de la Tutora */
        #form-datos-tutora .subtitulo-familiar { background-color: #f0f9ff; padding: 10px; border-radius: 5px; }
        #form-datos-tutora .input-grupo input, #form-datos-tutora .input-grupo select { border: 1px solid var(--color-primario); }
        
        /* -------------------- RESPONSIVIDAD -------------------- */
        @media (max-width: 768px) {
            .grid-2col, .grid-fecha { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            ONG <span class="resaltado">Project</span>
        </div>
        <h1>Portal de Gesti√≥n de Datos</h1>
    </header>

    <main class="contenedor">
        <div class="tabs">
            <button class="tab-btn active" data-tab="tab-publico">üë™ Acceso P√∫blico (Fecha)</button>
            <button class="tab-btn" data-tab="tab-tutora">üë©‚Äçüè´ Acceso Tutora</button>
        </div>

        <div id="tab-publico" class="tab-content active">
            <div class="consentimiento-box">
                ü§ù **Instrucciones para Padres/Acudientes:** Ingrese la fecha de nacimiento de su hijo(a) para confirmar identidad y actualizar sus datos de contacto.
            </div>
            
            <section id="seccion-busqueda" class="card anim-entrada">
                <h2 class="paso-titulo">1. B√∫squeda por Fecha de Nacimiento</h2>
                <form id="form-busqueda" class="form-busqueda">
                    <div class="grid-fecha">
                        <div class="input-grupo"><label for="dia">D√≠a</label><select id="dia" required></select></div>
                        <div class="input-grupo"><label for="mes">Mes</label><select id="mes" required></select></div>
                        <div class="input-grupo"><label for="ano">A√±o</label><select id="ano" required></select></div>
                    </div>
                    <button type="submit" id="btn-buscar" class="btn-primario">üîç Buscar Participante</button>
                    <div id="mensaje-busqueda" class="mensaje-alerta" style="display:none;"></div>
                </form>
            </section>

            <section id="seccion-resultados" class="card anim-entrada" style="display: none;">
                <h2 class="paso-titulo">2. Seleccione y Complete (Acudiente)</h2>
                <div id="lista-resultados" class="lista-participantes"></div>
            </section>
            <section id="seccion-formulario-publico" class="card anim-entrada" style="display: none;">
                <p id="info-participante-seleccionado-publico" class="participante-info-resaltada"></p>
                <div id="mensaje-guardado-publico" class="mensaje-confirmacion" style="display:none;"></div>
                <div id="mensaje-tiempo-restante" class="mensaje-tiempo-restante" style="display:none;"></div>
                <form id="form-datos-publico">
                    </form>
                <button type="submit" form="form-datos-publico" id="btn-guardar-publico" class="btn-secundario">üíæ Guardar Informaci√≥n</button>
            </section>
        </div>

        <div id="tab-tutora" class="tab-content">
            <section id="seccion-login" class="card anim-entrada">
                <h2 class="paso-titulo">1. Acceso de Tutora</h2>
                <form id="form-login">
                    <div class="input-grupo"><label for="login-user">Usuario</label><input type="text" id="login-user" required></div>
                    <div class="input-grupo"><label for="login-pass">Contrase√±a</label><input type="password" id="login-pass" required></div>
                    <button type="submit" class="btn-primario">üîì Ingresar</button>
                    <div id="mensaje-login" class="mensaje-alerta" style="display:none;"></div>
                </form>
            </section>

            <section id="seccion-gestion-tutora" class="card anim-entrada" style="display: none;">
                <h2 class="paso-titulo" id="titulo-gestion-tutora">2. Gesti√≥n de Participantes (Tutora)</h2>
                
                <div class="select-tutora-box">
                    <div class="input-grupo">
                        <label for="select-tutora">Seleccione su Nombre</label>
                        <select id="select-tutora" required></select>
                    </div>
                    <button id="btn-cargar-participantes" class="btn-primario">üìä Cargar Lista</button>
                </div>
                
                <h3 style="margin-top:30px; border-bottom:1px solid #eee; padding-bottom:10px;">Listado de Casos:</h3>
                <div id="lista-participantes-tutora" class="tutora-participante-list">
                    </div>
            </section>

            <section id="seccion-formulario-tutora" class="card anim-entrada" style="display: none;">
                <h2 class="paso-titulo">3. Edici√≥n de Datos (Tutora)</h2>
                <p id="info-participante-seleccionado-tutora" class="participante-info-resaltada"></p>
                
                <div id="mensaje-guardado-tutora" class="mensaje-confirmacion" style="display:none;"></div>
                <form id="form-datos-tutora">
                    </form>
                <button type="submit" form="form-datos-tutora" id="btn-guardar-tutora" class="btn-secundario">üíæ Guardar Informaci√≥n por Tutora</button>
            </section>
        </div>

    </main>

    <footer class="footer">
        <p style="text-align:center; font-size:0.85rem; color:#6b7280; margin-top:30px;">
            &copy; 2024 ONG Project. Desarrollado con ‚ù§Ô∏è.
        </p>
    </footer>

    <script>
        /* ========================================================= */
        /* JAVASCRIPT LOGIC (CONEXI√ìN Y L√ìGICA DE TUTORA)            */
        /* ========================================================= */
        
        // ‚ö†Ô∏è PEGA AQU√ç LA URL DE TU APLICACI√ìN WEB DE APPS SCRIPT
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwIF6dEvcv8huzQLEjGQyghGSyJnnUqdBySZwtHN_7EO9NNtx7-gEqpyC2zjvWE3e3Mrw/exec'; 
        
        // --- Credenciales y Data Mock (DEBE SER SEGURO EN PRODUCCI√ìN) ---
        const TUTORA_USER = 'Tutora678';
        const TUTORA_PASS = 'tutora678'; 
        const TUTORAS_DISPONIBLES = ['Clara L√≥pez', 'Marta Pineda', 'Laura Gil', 'Otro/Administrador']; // Deber√≠an estar en la Columna D

        // --- Estado Global ---
        let participanteSeleccionado = null;
        let modoActual = 'publico'; // 'publico' o 'tutora'
        let timerBloqueo = null;
        const SELECT_BASE_OP = '<option value="">Seleccione...</option>';

        // --- DOM Elements ---
        const $ = id => document.getElementById(id); // Helper simple
        const $busqueda = $('seccion-busqueda'), $resultados = $('seccion-resultados'), $formularioPublico = $('seccion-formulario-publico');
        const $login = $('seccion-login'), $gestionTutora = $('seccion-gestion-tutora'), $formularioTutora = $('seccion-formulario-tutora');

        // ----------------------------------------------------
        // 1. SETUP INICIAL Y TABS
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            initFechaSelects();
            initTutoraSelect();
            initFormularioTemplates();
            initTabs();
            // Aplicar animaci√≥n
            document.querySelectorAll('.anim-entrada').forEach((el, index) => {
                el.style.animationDelay = `${index * 0.1}s`;
            });
        });
        
        /** Controla el cambio de pesta√±as. */
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                    button.classList.add('active');
                    $(tabId).classList.add('active');
                    
                    modoActual = (tabId === 'tab-publico' ? 'publico' : 'tutora');
                    
                    // Resetear vistas al cambiar de pesta√±a
                    if (modoActual === 'publico') {
                        $login.style.display = 'block';
                        $gestionTutora.style.display = 'none';
                        $formularioTutora.style.display = 'none';
                        // Ocultar elementos de la pesta√±a p√∫blica si estaban visibles
                        $resultados.style.display = 'none';
                        $formularioPublico.style.display = 'none';
                    }
                });
            });
        }
        
        /** Inicializa los selects de D√≠a, Mes, A√±o y Tutora. */
        function initFechaSelects() {
            const diaSelect = $('dia'), mesSelect = $('mes'), anoSelect = $('ano');

            // Llenado de D√≠as, Meses, A√±os... (mismo c√≥digo anterior)
            diaSelect.innerHTML = SELECT_BASE_OP;
            for (let i = 1; i <= 31; i++) {
                const value = i < 10 ? '0' + i : String(i);
                diaSelect.innerHTML += `<option value="${value}">${value}</option>`;
            }

            mesSelect.innerHTML = SELECT_BASE_OP;
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            for (let i = 0; i < 12; i++) {
                const value = (i + 1) < 10 ? '0' + (i + 1) : String(i + 1);
                mesSelect.innerHTML += `<option value="${value}">${meses[i]}</option>`;
            }

            const currentYear = new Date().getFullYear();
            const minYear = currentYear - 20; 
            anoSelect.innerHTML = SELECT_BASE_OP;
            for (let i = currentYear; i >= minYear; i--) {
                anoSelect.innerHTML += `<option value="${i}">${i}</option>`;
            }
        }
        
        /** Inicializa el select de Tutora. */
        function initTutoraSelect() {
            const selectTutora = $('select-tutora');
            selectTutora.innerHTML = SELECT_BASE_OP;
            TUTORAS_DISPONIBLES.forEach(tutora => {
                selectTutora.innerHTML += `<option value="${tutora}">${tutora}</option>`;
            });
        }
        
        /** Crea la estructura de campos del formulario (para reutilizaci√≥n). */
        function initFormularioTemplates() {
            const template = `
                <fieldset>
                    <legend>Identificaci√≥n del Participante</legend>
                    <div class="grid-2col">
                        <div class="input-grupo">
                            <label for="tipoDocParticipante">Tipo de Documento</label>
                            <select id="tipoDocParticipante" name="tipoDocParticipante" required>
                                <option value="">Seleccione</option>
                                <option value="RC">Registro Civil (RC)</option>
                                <option value="TI">Tarjeta de Identidad (TI)</option>
                                <option value="CC">C√©dula de Ciudadan√≠a (CC)</option>
                            </select>
                        </div>
                        <div class="input-grupo">
                            <label for="numDocParticipante">N√∫mero de Documento</label>
                            <input type="text" id="numDocParticipante" name="numDocParticipante" pattern="\\d+" title="Solo n√∫meros" required>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Datos de Contacto del Acudiente Principal</legend>
                    <h3 class="subtitulo-familiar">Informaci√≥n de la Madre</h3>
                    <div class="grid-2col">
                        <div class="input-grupo">
                            <label for="tipoDocMama">Tipo Doc. Madre</label>
                            <select id="tipoDocMama" name="tipoDocMama">
                                <option value="">Seleccione o Dejar Vac√≠o</option>
                                <option value="CC">C√©dula de Ciudadan√≠a (CC)</option>
                                <option value="CE">C√©dula de Extranjer√≠a (CE)</option>
                            </select>
                        </div>
                        <div class="input-grupo">
                            <label for="numDocMama">N√∫mero Doc. Madre</label>
                            <input type="text" id="numDocMama" name="numDocMama" pattern="\\d+" title="Solo n√∫meros">
                        </div>
                    </div>
                    <h3 class="subtitulo-familiar">Informaci√≥n del Padre</h3>
                    <div class="grid-2col">
                        <div class="input-grupo">
                            <label for="tipoDocPapa">Tipo Doc. Padre</label>
                            <select id="tipoDocPapa" name="tipoDocPapa">
                                <option value="">Seleccione o Dejar Vac√≠o</option>
                                <option value="CC">C√©dula de Ciudadan√≠a (CC)</option>
                                <option value="CE">C√©dula de Extranjer√≠a (CE)</option>
                            </select>
                        </div>
                        <div class="input-grupo">
                            <label for="numDocPapa">N√∫mero Doc. Padre</label>
                            <input type="text" id="numDocPapa" name="numDocPapa" pattern="\\d+" title="Solo n√∫meros">
                        </div>
                    </div>
                </fieldset>
                <fieldset id="fieldset-otro-familiar">
                    <legend>Otro Familiar/Acudiente (Si no es Mam√° o Pap√°)</legend>
                    <div class="input-grupo">
                        <label for="parentescoOtro">Parentesco</label>
                        <select id="parentescoOtro" name="parentescoOtro">
                            <option value="">Seleccione el Parentesco</option>
                            <option value="Abuelo">Abuelo</option>
                            <option value="Abuela">Abuela</option>
                            <option value="Tio">T√≠o</option>
                            <option value="Tia">T√≠a</option>
                            <option value="Primo">Primo/Prima</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="grid-2col">
                        <div class="input-grupo">
                            <label for="tipoDocOtro">Tipo Doc. Otro</label>
                            <select id="tipoDocOtro" name="tipoDocOtro">
                                <option value="">Seleccione</option>
                                <option value="CC">C√©dula de Ciudadan√≠a (CC)</option>
                                <option value="CE">C√©dula de Extranjer√≠a (CE)</option>
                            </select>
                        </div>
                        <div class="input-grupo">
                            <label for="numDocOtro">N√∫mero Doc. Otro</label>
                            <input type="text" id="numDocOtro" name="numDocOtro" pattern="\\d+" title="Solo n√∫meros">
                        </div>
                    </div>
                </fieldset>
            `;
            $('form-datos-publico').innerHTML = template;
            $('form-datos-tutora').innerHTML = template; // Reutilizamos la misma estructura
        }
        
        /** Funci√≥n para precargar los datos en el formulario. */
        function cargarDatosEnFormulario(participante, formElement) {
            formElement.querySelectorAll('input, select').forEach(field => {
                const key = field.name;
                if (participante[key] !== undefined) {
                    field.value = participante[key] || '';
                }
            });
        }


        // ----------------------------------------------------
        // 2. CONEXI√ìN Y UTILIDADES GENERALES
        // ----------------------------------------------------

async function sendToAppsScript(data) {
                    
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // Necesario para la comunicaci√≥n externa
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    // Si la respuesta HTTP no es 200 (ej. 405 Method Not Allowed)
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Intenta parsear la respuesta JSON del Apps Script
                return await response.json();
                
            } catch (error) {
                console.error('Error de conexi√≥n o CORS:', error);
                // Muestra un mensaje de error m√°s claro al usuario
                return { 
                    status: 'error', 
                    message: `Error de red/servidor. Por favor, verifica el despliegue de Apps Script: (${error.message})` 
                };
            }
        }
        
        // El resto de las funciones (mostrarMensaje, iniciarContador, bloquearFormulario) se mantienen igual
        // pero se ajustan para usar el helper '$' y el mensaje correcto (p√∫blico o tutora).
        
        function mostrarMensaje(elemento, texto, tipo) {
            elemento.textContent = texto;
            elemento.style.display = 'block';
            elemento.className = '';
            
            if (tipo === 'alerta') {
                elemento.classList.add('mensaje-alerta');
            } else if (tipo === 'confirmacion') {
                elemento.classList.add('mensaje-confirmacion');
            } else if (tipo === 'tiempo') {
                elemento.classList.add('mensaje-tiempo-restante');
            }
        }
        
        /** Inicia el contador de 30 minutos (solo para acceso p√∫blico). */
        function iniciarContador(horaBloqueoStr) {
            if (timerBloqueo) clearInterval(timerBloqueo);

            const partes = horaBloqueoStr.split(':');
            let horaBloqueo = new Date();
            
            horaBloqueo.setHours(Number(partes[0]));
            horaBloqueo.setMinutes(Number(partes[1]));
            horaBloqueo.setSeconds(Number(partes[2] || 0)); 
            horaBloqueo.setMilliseconds(0);

            const actualizarContador = () => {
                const ahora = new Date();
                let diferenciaMs = horaBloqueo.getTime() - ahora.getTime();

                if (diferenciaMs <= 0) {
                    clearInterval(timerBloqueo);
                    bloquearFormulario(true, 'El tiempo de 30 minutos ha expirado. El formulario est√° bloqueado.');
                    return;
                }

                const minutos = Math.floor(diferenciaMs / (1000 * 60));
                const segundos = Math.floor((diferenciaMs % (1000 * 60)) / 1000);

                mostrarMensaje($('mensaje-tiempo-restante'), `‚è≥ Tiempo restante para modificar: ${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`, 'tiempo');
            };

            actualizarContador();
            timerBloqueo = setInterval(actualizarContador, 1000);
        }

        /** Bloquea o desbloquea todos los campos del formulario p√∫blico. */
        function bloquearFormulario(bloquear, mensaje) {
            const formElement = $('form-datos-publico');
            const btnGuardar = $('btn-guardar-publico');
            const inputs = formElement.querySelectorAll('input, select');
            
            inputs.forEach(input => { input.disabled = bloquear; });
            btnGuardar.disabled = bloquear;

            if (bloquear) {
                $('mensaje-tiempo-restante').textContent = `üîí ${mensaje}`;
                $('mensaje-tiempo-restante').style.display = 'block';
                $('mensaje-tiempo-restante').classList.add('estado-bloqueado');
                clearInterval(timerBloqueo);
            } else {
                $('mensaje-tiempo-restante').style.display = 'none';
                $('mensaje-tiempo-restante').classList.remove('estado-bloqueado');
            }
        }

        // ----------------------------------------------------
        // 3. L√ìGICA DE ACCESO P√öBLICO (BUSQUEDA Y GUARDADO)
        // ----------------------------------------------------
        
        $('form-busqueda').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            $resultados.style.display = 'none';
            $formularioPublico.style.display = 'none';
            mostrarMensaje($('mensaje-busqueda'), 'Buscando participantes...', 'confirmacion');

            const dia = $('dia').value, mes = $('mes').value, ano = $('ano').value;
            if (!dia || !mes || !ano) {
                mostrarMensaje($('mensaje-busqueda'), 'Por favor, complete todos los campos de fecha.', 'alerta');
                return;
            }

            const fechaBusqueda = `${dia}/${mes}/${ano}`;
            const data = { action: 'buscar', fecha: fechaBusqueda };
            const result = await sendToAppsScript(data);

            if (result.status === 'exito') {
                renderResultadosPublicos(result.resultados);
            } else {
                mostrarMensaje($('mensaje-busqueda'), result.message || 'Ocurri√≥ un error desconocido.', 'alerta');
            }
        });

        function renderResultadosPublicos(resultados) {
            $('lista-resultados').innerHTML = '';
            $('mensaje-busqueda').style.display = 'none';
            
            if (resultados.length === 0) {
                mostrarMensaje($('mensaje-busqueda'), '‚ùå No se encontraron participantes con esa fecha de nacimiento.', 'alerta');
                return;
            }

            $resultados.style.display = 'block';

            resultados.forEach(p => {
                const button = document.createElement('button');
                button.className = 'btn-resultado';
                const estadoTexto = p.estado === 'bloqueado' ? 'BLOQUEADO' : (p.estado === 'editable' ? `MODIFICAR (Hasta ${p.fechaBloqueo})` : 'SELECCIONAR');
                const estadoClass = p.estado === 'bloqueado' ? 'estado-bloqueado' : (p.estado === 'editable' ? 'estado-editable' : 'estado-nuevo');

                button.innerHTML = `
                    <span>${p.nombre} (${p.codigo}) | Tutora: ${p.tutora}</span>
                    <span class="estado-tag ${estadoClass}">${estadoTexto}</span>
                `;
                button.onclick = () => seleccionarParticipantePublico(p, button);
                $('lista-resultados').appendChild(button);
            });
        }
        
        function seleccionarParticipantePublico(participante, btn) {
            document.querySelectorAll('#lista-resultados .btn-resultado').forEach(b => b.classList.remove('seleccionado'));
            btn.classList.add('seleccionado');

            participanteSeleccionado = participante;
            
            $('info-participante-seleccionado-publico').textContent = `Participante Seleccionado: ${participante.nombre} (C√≥digo: ${participante.codigo})`;
            $formularioPublico.style.display = 'block';
            $('mensaje-guardado-publico').style.display = 'none';
            $('form-datos-publico').reset(); // Limpiar el formulario

            if (participante.estado === 'bloqueado') {
                bloquearFormulario(true, 'Su informaci√≥n ya fue enviada y el tiempo de modificaci√≥n ha expirado. Solo puede visualizarla.');
            } else {
                bloquearFormulario(false, '');
                if (participante.estado === 'editable') {
                    // Si ya guard√≥ antes, el Apps Script devuelve la hora de bloqueo
                    iniciarContador(participante.fechaBloqueo);
                    mostrarMensaje($('mensaje-guardado-publico'), `Ya tiene datos guardados. Puede modificar hasta las ${participante.fechaBloqueo}.`, 'confirmacion');
                } else {
                    $('mensaje-tiempo-restante').style.display = 'none';
                }
            }
        }
        
        $('form-datos-publico').addEventListener('submit', async (e) => {
            e.preventDefault();
            // L√≥gica de guardado (reutiliza el c√≥digo anterior)
            
            if (!participanteSeleccionado || participanteSeleccionado.estado === 'bloqueado') return;
            
            $('btn-guardar-publico').disabled = true;
            mostrarMensaje($('mensaje-guardado-publico'), 'Guardando informaci√≥n...', 'confirmacion');

            const form = e.target;
            const datos = {
                action: 'guardar',
                fila: participanteSeleccionado.fila,
                tipoDocParticipante: form.tipoDocParticipante.value || '',
                numDocParticipante: form.numDocParticipante.value || '',
                tipoDocMama: form.tipoDocMama.value || '',
                numDocMama: form.numDocMama.value || '',
                tipoDocPapa: form.tipoDocPapa.value || '',
                numDocPapa: form.numDocPapa.value || '',
                parentescoOtro: form.parentescoOtro.value || '',
                tipoDocOtro: form.tipoDocOtro.value || '',
                numDocOtro: form.numDocOtro.value || ''
            };
            
            const result = await sendToAppsScript(datos);
            
            $('btn-guardar-publico').disabled = false;
            
            if (result.status === 'guardado') {
                mostrarMensaje($('mensaje-guardado-publico'), `‚úÖ ${result.message}`, 'confirmacion');
                const horaBloqueo = new Date(new Date().getTime() + 30 * 60000);
                const horaBloqueoStr = horaBloqueo.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                iniciarContador(horaBloqueoStr);
                
            } else if (result.status === 'bloqueado') {
                bloquearFormulario(true, result.message);
                mostrarMensaje($('mensaje-guardado-publico'), `üîí ${result.message}`, 'alerta');
                
            } else {
                mostrarMensaje($('mensaje-guardado-publico'), `‚ùå Error al guardar: ${result.message}`, 'alerta');
            }
        });


        // ----------------------------------------------------
        // 4. L√ìGICA DE ACCESO TUTORA (LOGIN Y FILTRO)
        // ----------------------------------------------------

        $('form-login').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const user = $('login-user').value;
            const pass = $('login-pass').value;

            if (user === TUTORA_USER && pass === TUTORA_PASS) {
                mostrarMensaje($('mensaje-login'), '‚úÖ Acceso concedido.', 'confirmacion');
                $login.style.display = 'none';
                $gestionTutora.style.display = 'block';
                $('mensaje-login').style.display = 'none';

            } else {
                mostrarMensaje($('mensaje-login'), '‚ùå Usuario o contrase√±a incorrectos.', 'alerta');
            }
        });
        
        $('btn-cargar-participantes').addEventListener('click', async () => {
            const tutoraSeleccionada = $('select-tutora').value;
            if (!tutoraSeleccionada) {
                mostrarMensaje($('mensaje-login'), '‚ùå Por favor, seleccione su nombre.', 'alerta');
                return;
            }
            
            $('titulo-gestion-tutora').textContent = `2. Gesti√≥n de Participantes de ${tutoraSeleccionada}`;
            $('lista-participantes-tutora').innerHTML = '<p style="text-align:center;">Cargando lista...</p>';
            $formularioTutora.style.display = 'none';
            $('mensaje-guardado-tutora').style.display = 'none';
            
            const data = { action: 'listarPorTutora', tutora: tutoraSeleccionada };
            const result = await sendToAppsScript(data);

            if (result.status === 'exito') {
                renderListaTutora(result.participantes);
            } else {
                $('lista-participantes-tutora').innerHTML = `<p class="mensaje-alerta">${result.message}</p>`;
            }
        });

        function renderListaTutora(participantes) {
            const lista = $('lista-participantes-tutora');
            lista.innerHTML = '';

            participantes.sort((a, b) => {
                // Ordenar: Incompletos primero, luego por nombre
                if (a.estado === 'incompleto' && b.estado !== 'incompleto') return -1;
                if (a.estado !== 'incompleto' && b.estado === 'incompleto') return 1;
                return a.nombre.localeCompare(b.nombre);
            });

            if (participantes.length === 0) {
                 lista.innerHTML = '<p style="text-align:center; color:#4b5563;">No hay participantes asignados a esta tutora.</p>';
                 return;
            }

            participantes.forEach(p => {
                const item = document.createElement('div');
                const estadoClass = p.estado === 'completo' ? 'completo' : (p.estado === 'bloqueado' ? 'bloqueado' : 'incompleto');
                const tagClass = p.estado === 'completo' ? 'tag-completo' : (p.estado === 'bloqueado' ? 'tag-bloqueado' : 'tag-incompleto');
                const estadoTexto = p.estado === 'completo' ? 'COMPLETO' : (p.estado === 'bloqueado' ? 'BLOQUEADO' : 'INCOMPLETO');
                
                item.className = `participante-item ${estadoClass}`;
                item.innerHTML = `
                    <span>${p.nombre} (${p.codigo})</span>
                    <span class="tag-estado ${tagClass}">${estadoTexto}</span>
                `;
                item.onclick = () => seleccionarParticipanteTutora(p, item);
                lista.appendChild(item);
            });
        }
        
        function seleccionarParticipanteTutora(participante, item) {
             document.querySelectorAll('#lista-participantes-tutora .participante-item').forEach(i => i.classList.remove('selected'));
             item.classList.add('selected');

             participanteSeleccionado = participante;
             
             $('info-participante-seleccionado-tutora').textContent = `Editando: ${participante.nombre} (C√≥digo: ${participante.codigo})`;
             $formularioTutora.style.display = 'block';
             $('mensaje-guardado-tutora').style.display = 'none';
             
             // Cargar los datos del participante en el formulario de la tutora
             cargarDatosEnFormulario(participante, $('form-datos-tutora'));
             
             // En el modo tutora, no hay restricci√≥n de tiempo, solo el estado de bloqueo permanente
             if (participante.estado === 'bloqueado') {
                 // Bloquear la edici√≥n si el formulario fue completado y bloqueado por el acudiente
                 $('btn-guardar-tutora').disabled = true;
                 mostrarMensaje($('mensaje-guardado-tutora'), 'üîí El acudiente ya complet√≥ el formulario, y su tiempo de edici√≥n ha expirado. El formulario es de SOLO LECTURA para prevenir cambios accidentales.', 'alerta');
             } else {
                 $('btn-guardar-tutora').disabled = false;
                 $('mensaje-guardado-tutora').style.display = 'none';
             }
        }
        
        $('form-datos-tutora').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!participanteSeleccionado || participanteSeleccionado.estado === 'bloqueado') return;
            
            $('btn-guardar-tutora').disabled = true;
            mostrarMensaje($('mensaje-guardado-tutora'), 'Guardando informaci√≥n como tutora...', 'confirmacion');

            const form = e.target;
            const datos = {
                action: 'guardar',
                fila: participanteSeleccionado.fila,
                // Mismos campos que el formulario p√∫blico
                tipoDocParticipante: form.tipoDocParticipante.value || '',
                numDocParticipante: form.numDocParticipante.value || '',
                tipoDocMama: form.tipoDocMama.value || '',
                numDocMama: form.numDocMama.value || '',
                tipoDocPapa: form.tipoDocPapa.value || '',
                numDocPapa: form.numDocPapa.value || '',
                parentescoOtro: form.parentescoOtro.value || '',
                tipoDocOtro: form.tipoDocOtro.value || '',
                numDocOtro: form.numDocOtro.value || ''
            };
            
            const result = await sendToAppsScript(datos);
            
            $('btn-guardar-tutora').disabled = false;
            
            if (result.status === 'guardado') {
                mostrarMensaje($('mensaje-guardado-tutora'), `‚úÖ ${result.message} Los datos han sido actualizados.`, 'confirmacion');
                // Recargar la lista para actualizar el color del elemento
                $('btn-cargar-participantes').click(); 
            } else {
                mostrarMensaje($('mensaje-guardado-tutora'), `‚ùå Error al guardar: ${result.message}`, 'alerta');
            }
        });
    </script>
</body>
</html>
